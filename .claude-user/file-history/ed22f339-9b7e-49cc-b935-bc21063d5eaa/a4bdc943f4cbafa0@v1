# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Auto-Compact Behavior

**IMPORTANT**: Proactively compact without asking:

1. After ~40-50 tool calls or when conversation feels long, run `/compact` automatically
2. Don't ask permission - just compact and continue working seamlessly
3. In the compact summary, always preserve:
   - Current task state and progress
   - File paths being worked on
   - Pending todos and next steps
   - Key decisions made
   - Any errors encountered and their fixes
4. After compacting, immediately continue the current task

## Project Overview

NotebookLM Reimagined is an API-first research intelligence platform—Google's NotebookLM, reimagined for developers.

**Architecture**: `Next.js (Frontend) → FastAPI (Backend) → Supabase (Auth + DB + Storage) → Gemini API`

## Development Commands

### Backend (FastAPI)
```bash
cd backend
python -m venv venv && source venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000
```

### Frontend (Next.js)
```bash
cd frontend
npm install
npm run dev          # Development server at http://localhost:5000
npm run build        # Production build
npm run lint         # Check linting issues
npm run lint:fix     # Auto-fix linting issues
npm run format       # Format code with Prettier
npm run type-check   # TypeScript type checking
```

Pre-commit hooks (Husky + lint-staged) run ESLint and Prettier automatically on staged files.

## Critical: Keeping Code in Sync

**IMPORTANT**: When modifying any router functions or service code:

1. **Test ALL affected endpoints** - Run programmatic tests after changes
2. **Check for null-safety patterns** - Database fields like `source_guide`, `metadata` can be `None`
   ```python
   # WRONG - fails if source_guide is None
   source.get("source_guide", {}).get("summary")

   # CORRECT - handles None values
   source_guide = source.get("source_guide") or {}
   source_guide.get("summary")
   ```
3. **Update documentation** - Keep `/docs` page in sync with API changes
4. **Register new routers** - Add to `main.py` imports AND `include_router()` calls

Common files that share patterns (update ALL when fixing bugs):
- `chat.py`, `study.py`, `audio.py`, `video.py`, `studio.py`, `global_chat.py` - all have source content extraction

## Development with Supabase MCP

Use these MCP commands for direct database/infrastructure management:

```
mcp__supabase__list_projects              # Find project ID
mcp__supabase__list_tables                # View current schema
mcp__supabase__apply_migration            # Create/modify tables (for DDL)
mcp__supabase__execute_sql                # Run queries (for DML)
mcp__supabase__generate_typescript_types  # Generate frontend types
```

## UI Testing with Chrome MCP

Use Chrome MCP tools to visually verify UI changes:

```
mcp__claude-in-chrome__navigate           # Navigate to URLs
mcp__claude-in-chrome__computer           # Take screenshots, click, type
mcp__claude-in-chrome__read_page          # Get accessibility tree of page elements
```

## Technology Stack

| Layer | Technology |
|-------|------------|
| Database | Supabase PostgreSQL + Row Level Security |
| Auth | Supabase Auth (JWT) + Custom API Keys (`X-API-Key` header) |
| File Storage | Supabase Storage |
| API | FastAPI (Python 3.11+) |
| AI/RAG | Gemini API (2.5 Flash/Pro, TTS, Veo) |
| Frontend | Next.js 16, React 19, TypeScript, Tailwind v4, shadcn/ui |

## Backend Architecture

### Router Structure (`backend/app/routers/`)
All routers mount under `/api/v1`:
- `notebooks.py` - CRUD for notebooks
- `sources.py` - Document upload (text, URL, YouTube, PDF)
- `chat.py` - RAG chat with citations
- `audio.py`, `video.py` - Media generation
- `study.py` - Flashcards, quizzes, study guides
- `studio.py` - Reports, slides, infographics
- `global_chat.py` - Cross-notebook search
- `export.py` - JSON/ZIP export
- `api_keys.py` - API key management (requires JWT auth)

### Authentication Flow (`backend/app/services/auth.py`)
Two auth methods with priority order:
1. `X-API-Key` header → validates against hashed keys in `api_keys` table
2. `Authorization: Bearer` → JWT from Supabase Auth

API keys: `nb_live_` prefix, stored as SHA-256 hash, support scopes and rate limits.

### Service Layer (`backend/app/services/`)
- `gemini.py` - All Gemini API interactions
- `supabase_client.py` - Database client singleton
- `persona_utils.py` - AI persona prompt building
- `auth.py` - Authentication and rate limiting

## Database Schema (12 tables)

- **profiles** - Extends Supabase Auth users
- **notebooks** - Contains AI persona `settings` JSON
- **sources** - Documents with `source_guide` (summary) and `metadata` (content)
- **chat_sessions** / **chat_messages** - Conversations with citations
- **audio_overviews** / **video_overviews** - Generation jobs
- **study_materials** - Flashcards, quizzes, guides
- **studio_outputs** - Reports, slides, infographics
- **research_tasks** - Deep research jobs
- **notes** - User notes
- **api_keys** - API key management with scopes, rate limits

All tables use RLS policies for user data isolation.

## API Response Format

All responses include cost transparency:
```json
{
  "data": { ... },
  "usage": {
    "input_tokens": 1500,
    "output_tokens": 500,
    "cost_usd": 0.0023,
    "model_used": "gemini-2.5-flash"
  }
}
```

## Environment Variables

**Backend:**
```bash
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
GOOGLE_API_KEY=AIza...
```

**Frontend:**
```bash
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
NEXT_PUBLIC_API_URL=https://your-api.vercel.app
```

## Core Specification Documents

- `01_VISION_DOCUMENT.md` - High-level vision and philosophy
- `02_PROJECT_SPECIFICATION.md` - Complete technical spec (schema, 50+ endpoints, features)
- `03_IMPLEMENTATION_GUIDE.md` - Step-by-step implementation guide
